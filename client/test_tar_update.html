<!DOCTYPE html>
<html>
<head>
    <title>Test TAR Update</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
        #console { background: #f0f0f0; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>TAR Currency Update Test</h1>
    
    <div class="test-section">
        <h3>Current TAR Rate</h3>
        <button onclick="checkCurrentRate()">Check Current TAR Rate</button>
        <div id="currentRate"></div>
    </div>
    
    <div class="test-section">
        <h3>Update TAR Rate</h3>
        <input type="number" id="newRate" placeholder="Enter new rate" step="0.01" value="0.3">
        <button onclick="updateTARRate()">Update TAR to New Rate</button>
        <div id="updateResult"></div>
    </div>
    
    <div class="test-section">
        <h3>Console Output</h3>
        <div id="console"></div>
    </div>

    <script>
        const SERVICE_URL = 'http://localhost:8000/CurrencyConversionService/services/CurrencyConverter';
        let consoleDiv = document.getElementById('console');
        
        function log(message) {
            console.log(message);
            consoleDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function createSOAPEnvelope(method, params) {
            return `<?xml version="1.0" encoding="UTF-8"?>
                <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
                               xmlns:cur="http://service.currency.com">
                    <soap:Header/>
                    <soap:Body>
                        <cur:${method}>
                            ${params}
                        </cur:${method}>
                    </soap:Body>
                </soap:Envelope>`;
        }
        
        function sendSOAPRequest(soapBody, callback) {
            log('Sending SOAP request for: ' + soapBody.match(/<cur:(\w+)>/)[1]);
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', SERVICE_URL, true);
            xhr.setRequestHeader('Content-Type', 'text/xml; charset=utf-8');
            xhr.setRequestHeader('SOAPAction', '');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    log('Response status: ' + xhr.status);
                    log('Response text: ' + xhr.responseText);
                    
                    if (xhr.status === 200) {
                        callback(null, xhr.responseText);
                    } else {
                        callback(new Error('Request failed: ' + xhr.status + ' - ' + xhr.statusText), null);
                    }
                }
            };
            
            xhr.onerror = function() {
                log('XMLHttpRequest error occurred');
                callback(new Error('Network error occurred'), null);
            };
            
            xhr.send(soapBody);
        }
        
        function parseSOAPResponse(response) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(response, 'text/xml');
            
            log('Parsing SOAP response...');
            
            // Try different possible return element names and namespaces
            let returnElement = xmlDoc.getElementsByTagName('ns:return')[0] || 
                               xmlDoc.getElementsByTagName('return')[0] ||
                               xmlDoc.querySelector('return') ||
                               xmlDoc.querySelector('[localName="return"]');
            
            // If still not found, try more specific searches
            if (!returnElement) {
                const allElements = xmlDoc.getElementsByTagName('*');
                for (let i = 0; i < allElements.length; i++) {
                    if (allElements[i].localName === 'return' || allElements[i].tagName.endsWith(':return')) {
                        returnElement = allElements[i];
                        break;
                    }
                }
            }
            
            if (returnElement) {
                const result = returnElement.textContent.trim();
                log('Extracted result: ' + result);
                return result;
            } else {
                log('ERROR: Could not find return element in response');
                return null;
            }
        }
        
        function checkCurrentRate() {
            const soapBody = createSOAPEnvelope('getAllRates', '');
            
            sendSOAPRequest(soapBody, function(error, response) {
                const resultDiv = document.getElementById('currentRate');
                if (error) {
                    resultDiv.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
                    log('Error getting current rates: ' + error.message);
                } else {
                    const result = parseSOAPResponse(response);
                    if (result) {
                        const tarMatch = result.match(/TAR = ([0-9.]+)/);
                        if (tarMatch) {
                            const currentTARRate = tarMatch[1];
                            resultDiv.innerHTML = '<p class="info">Current TAR rate: ' + currentTARRate + '</p>';
                            log('Current TAR rate: ' + currentTARRate);
                        } else {
                            resultDiv.innerHTML = '<p class="error">TAR not found in rates</p>';
                            log('TAR not found in rates');
                        }
                    } else {
                        resultDiv.innerHTML = '<p class="error">Could not parse rates result</p>';
                        log('Could not parse rates result');
                    }
                }
            });
        }
        
        function updateTARRate() {
            const newRate = document.getElementById('newRate').value;
            
            if (!newRate) {
                document.getElementById('updateResult').innerHTML = '<p class="error">Please enter a new rate</p>';
                return;
            }
            
            log('Updating TAR rate to: ' + newRate);
            
            const params = `
                <cur:currency>TAR</cur:currency>
                <cur:rate>${newRate}</cur:rate>
            `;
            
            const soapBody = createSOAPEnvelope('updateExchangeRate', params);
            
            sendSOAPRequest(soapBody, function(error, response) {
                const resultDiv = document.getElementById('updateResult');
                if (error) {
                    resultDiv.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
                    log('Update error: ' + error.message);
                } else {
                    const result = parseSOAPResponse(response);
                    if (result) {
                        const isSuccess = result.includes('Success');
                        resultDiv.innerHTML = '<p class="' + (isSuccess ? 'success' : 'error') + '">' + result + '</p>';
                        log('Update result: ' + result);
                        
                        if (isSuccess) {
                            log('Update successful! Checking current rate...');
                            setTimeout(checkCurrentRate, 1000);
                        }
                    } else {
                        resultDiv.innerHTML = '<p class="error">Could not parse update result</p>';
                        log('Could not parse update result');
                    }
                }
            });
        }
        
        // Initialize on page load
        window.onload = function() {
            log('TAR Update Test Page loaded');
            checkCurrentRate();
        };
    </script>
</body>
</html> 